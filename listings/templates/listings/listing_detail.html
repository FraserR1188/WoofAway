{% extends "base.html" %}

{% block extra_title %}{{ listing.title }}{% endblock %}

{% block page_header %}
<section class="bg-white border-bottom py-3">
  <div class="container">
    <h1 class="mb-0">{{ listing.title }}</h1>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="container py-4">

  {# === Listing Image === #}
  {% if listing.image %}
    <div class="mb-4 text-center">
      <img 
        src="{{ listing.image.url }}" 
        alt="{{ listing.title }}" 
        class="img-fluid rounded shadow-sm" 
        style="max-height: 400px; object-fit: cover;"
      >
    </div>
  {% endif %}

  <div class="row gx-4">
    <div class="col-md-8">
      <ul class="list-unstyled mb-4">
        <li><strong>Category:</strong> {{ listing.category|default:"—" }}</li>
        <li><strong>Location:</strong> {{ listing.location }}</li>
        <li><strong>Price per night:</strong> £{{ listing.price_per_night }}</li>
      </ul>
      <p class="mb-4">{{ listing.description }}</p>

      <div class="mb-5">
        {% if user.is_authenticated and listing.host == user %}
          <a 
            href="{% url 'listings:listing_edit' listing.pk %}" 
            class="btn btn-outline-secondary me-2"
          >
            Edit Listing
          </a>
        {% endif %}
        <a 
          href="{% url 'listings:listing_list' %}" 
          class="btn btn-outline-primary"
        >
          Back to All Listings
        </a>
      </div>

      {# ==== Reviews Section ==== #}
      <section class="mb-5">
        <h3 class="mb-3">Reviews</h3>
        {% if listing.reviews.exists %}
          <ul class="list-group">
            {% for review in listing.reviews.all %}
              <li class="list-group-item shadow-sm mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>{{ review.guest.username }}</strong>
                    <small class="text-muted">— {{ review.created_at|date:"M d, Y" }}</small>
                    <div class="mt-1">
                      {# ★ filled #}
                      {% for _ in "12345"|slice:":{{ review.rating }}" %}
                        <span class="text-warning">&#9733;</span>
                      {% endfor %}
                      {# ☆ empty #}
                      {% for _ in "12345"|slice:"{{ review.rating }}:" %}
                        <span class="text-muted">&#9734;</span>
                      {% endfor %}
                    </div>
                    <p class="mt-2 mb-0">{{ review.comment }}</p>
                  </div>
                  {% if user == review.guest %}
                    <div class="align-self-start">
                      <a 
                        href="{% url 'reviews:review_edit' review.pk %}" 
                        class="btn btn-sm btn-outline-secondary me-1"
                      >
                        Edit
                      </a>
                      <a 
                        href="{% url 'reviews:review_delete' review.pk %}" 
                        class="btn btn-sm btn-outline-danger"
                      >
                        Delete
                      </a>
                    </div>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No reviews yet. Be the first to leave one!</p>
        {% endif %}
      </section>

      {# ==== Leave a Review CTA ==== #}
      {% if user.is_authenticated and user != listing.host %}
        <a 
          href="{% url 'reviews:review_create' listing.pk %}" 
          class="btn btn-success mb-5"
        >
          Leave a Review
        </a>
      {% endif %}
    </div>

    {# ==== Sidebar: Booking CTA ==== #}
    <aside class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h4 class="card-title mb-3">£{{ listing.price_per_night }}/night</h4>

          {% if user.is_authenticated %}
            {% if user != listing.host %}
              <a 
                href="{% url 'bookings:booking_create' listing.pk %}" 
                class="btn btn-primary btn-lg w-100 mb-2"
              >
                Book Now
              </a>
            {% else %}
              <p class="text-muted">You’re the host of this listing.</p>
            {% endif %}
          {% else %}
            <a 
              href="{% url 'account_login' %}?next={% url 'bookings:booking_create' listing.pk %}" 
              class="btn btn-primary btn-lg w-100 mb-2"
            >
              Login to Book
            </a>
          {% endif %}
        </div>
      </div>
    </aside>
  </div>
</div>
{% endblock %}
